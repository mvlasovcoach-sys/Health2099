<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Map snapshots</title>
    <meta name="theme-color" content="#2563eb" />
    <link rel="manifest" href="./manifest.webmanifest" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-o9N1j7kGStpBlXnKzHf0C6YxM0tZQYVI0eCFj0zPmL0=" crossorigin="" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="./shared/styles.css" />
    <style>
      body {
        background: #0f172a;
      }
      .app-shell {
        background-image: none;
        background: radial-gradient(circle at top, rgba(15, 23, 42, 0.96), rgba(2, 6, 23, 0.9));
      }
    </style>
  </head>
  <body class="app-shell">
    <div data-include="nav"></div>
    <main class="app-main">
      <div class="container flow">
        <header class="page-header">
          <span class="page-header__eyebrow">Map</span>
          <h1>Location snapshots</h1>
          <p>Capture manual or device-based locations to build a private map of your wellbeing journey. Everything stays offline and stored locally.</p>
          <span class="badge">Local only</span>
        </header>

        <div class="map-layout">
          <aside class="map-sidebar">
            <section class="map-card">
              <h2 style="margin:0; font-size:1.1rem; color:var(--color-heading);">Controls</h2>
              <div class="map-toolbar">
                <button type="button" id="my-location">My location</button>
                <button type="button" id="snapshot">Snapshot</button>
                <button type="button" class="secondary" id="show-day">Show day</button>
                <button type="button" class="secondary" id="show-week">Show week</button>
                <button type="button" class="secondary" id="show-month">Show month</button>
              </div>
              <label>
                <span>Select date</span>
                <input type="date" id="date-input" />
              </label>
              <label>
                <span>Search notes</span>
                <input type="search" id="search-input" placeholder="Filter notes" />
              </label>
              <div class="map-toolbar">
                <button type="button" class="secondary" id="export-map">Export JSON</button>
                <button type="button" class="secondary" id="import-map">Import JSON</button>
                <input type="file" id="import-file" accept="application/json" />
              </div>
            </section>

            <section class="map-card">
              <h2 style="margin:0; font-size:1.1rem; color:var(--color-heading);">History</h2>
              <div id="history-count" class="tag">0 snapshots</div>
              <div id="history-list" class="map-list"></div>
              <div class="empty-state" id="history-empty" style="display:none;">
                <p style="margin:0 0 0.75rem;">No snapshots yet for this range.</p>
                <p style="margin:0; font-size:0.85rem;">Tip: enable location on HTTPS or use localhost for device snapshots. Otherwise, capture from the map center.</p>
              </div>
            </section>
          </aside>

          <section class="map-panel">
            <div id="map"></div>
          </section>
        </div>
      </div>
    </main>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>

    <script src="./shared/storage.js"></script>
    <script src="./shared/nav-loader.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-o9N1j7kGStpBlXnKzHf0C6YxM0tZQYVI0eCFj0zPmL0=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
      (function () {
        const toast = document.getElementById('toast');
        const myLocationBtn = document.getElementById('my-location');
        const snapshotBtn = document.getElementById('snapshot');
        const dateInput = document.getElementById('date-input');
        const showDayBtn = document.getElementById('show-day');
        const showWeekBtn = document.getElementById('show-week');
        const showMonthBtn = document.getElementById('show-month');
        const searchInput = document.getElementById('search-input');
        const historyList = document.getElementById('history-list');
        const historyCount = document.getElementById('history-count');
        const historyEmpty = document.getElementById('history-empty');
        const exportBtn = document.getElementById('export-map');
        const importBtn = document.getElementById('import-map');
        const importFile = document.getElementById('import-file');

        const DEFAULT_VIEW = [37.773972, -122.431297];
        const state = {
          mode: 'day',
          query: '',
          anchor: new Date(),
        };

        const map = L.map('map', { zoomControl: true });
        map.setView(DEFAULT_VIEW, 4);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors',
          maxZoom: 19,
        }).addTo(map);

        let markerLayer = L.layerGroup().addTo(map);

        dateInput.value = toInputValue(state.anchor);

        function toInputValue(date) {
          return new Date(date).toISOString().slice(0, 10);
        }

        function showToast(message) {
          toast.textContent = message;
          toast.classList.add('visible');
          setTimeout(() => toast.classList.remove('visible'), 2400);
        }

        function refresh() {
          state.anchor = new Date(dateInput.value || new Date());
          const locations = getLocations();
          renderMarkers(locations);
          renderList(locations);
        }

        function getLocations() {
          const anchor = new Date(dateInput.value || new Date());
          let locations = [];
          if (state.mode === 'day') {
            locations = StorageAPI.locationsByDate(anchor);
          } else if (state.mode === 'week') {
            const start = startOfWeek(anchor);
            const end = endOfWeek(anchor);
            locations = StorageAPI.locationsInRange(start, end);
          } else if (state.mode === 'month') {
            const start = startOfMonth(anchor);
            const end = endOfMonth(anchor);
            locations = StorageAPI.locationsInRange(start, end);
          }
          if (state.query) {
            const search = state.query.toLowerCase();
            locations = locations.filter((location) => (location.note || '').toLowerCase().includes(search));
          }
          return locations.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        }

        function renderMarkers(locations) {
          if (markerLayer) {
            markerLayer.removeFrom(map);
          }
          markerLayer = locations.length > 100 ? L.markerClusterGroup({ chunkedLoading: true }) : L.layerGroup();
          locations.forEach((location) => {
            const marker = L.marker([location.lat, location.lng]);
            marker.locationId = location.id;
            marker.bindPopup(popupContent(location));
            markerLayer.addLayer(marker);
          });
          markerLayer.addTo(map);
          if (locations.length) {
            const bounds = L.latLngBounds(locations.map((location) => [location.lat, location.lng]));
            map.fitBounds(bounds.pad(0.2));
          } else {
            map.setView(DEFAULT_VIEW, 4);
          }
        }

        map.on('popupopen', (event) => {
          const container = event.popup.getElement();
          if (!container) return;
          const { locationId } = event.popup._source || {};
          const editBtn = container.querySelector('[data-action="edit"]');
          const deleteBtn = container.querySelector('[data-action="delete"]');
          if (editBtn) {
            editBtn.addEventListener('click', () => {
              event.popup.close();
              handleEdit(locationId);
            });
          }
          if (deleteBtn) {
            deleteBtn.addEventListener('click', () => {
              event.popup.close();
              handleDelete(locationId);
            });
          }
        });

        function popupContent(location) {
          const accuracy = location.accuracy_m != null ? `${Math.round(location.accuracy_m)} m` : 'â€”';
          const note = location.note ? escapeHtml(location.note) : '<em>No note</em>';
          return `
            <div class="map-popup">
              <strong>${formatDate(location.created_at)}</strong><br />
              <span>Accuracy: ${accuracy}</span><br />
              <span>Source: ${location.source}</span>
              <p style="margin:0.5rem 0 0;">${note}</p>
              <div style="margin-top:0.5rem; display:flex; gap:0.5rem;">
                <button type="button" data-action="edit">Edit note</button>
                <button type="button" class="danger" data-action="delete">Delete</button>
              </div>
            </div>
          `;
        }

        function renderList(locations) {
          historyList.innerHTML = '';
          historyCount.textContent = `${locations.length} snapshot${locations.length === 1 ? '' : 's'}`;
          if (!locations.length) {
            historyEmpty.style.display = 'block';
            return;
          }
          historyEmpty.style.display = 'none';
          locations.forEach((location) => {
            const item = document.createElement('div');
            item.className = 'map-list-item';
            item.innerHTML = `
              <div class="map-list-item__meta">
                <span>${formatDate(location.created_at)}</span>
                <span class="tag">${location.source}</span>
              </div>
              <div>${location.note ? escapeHtml(location.note) : '<em style="color:var(--color-muted);">No note</em>'}</div>
              <div class="map-list-item__actions">
                <button type="button" class="ghost" data-action="focus">Focus</button>
                <button type="button" class="secondary" data-action="edit">Edit note</button>
                <button type="button" class="danger" data-action="delete">Delete</button>
              </div>
            `;
            item.querySelector('[data-action="focus"]').addEventListener('click', () => focusLocation(location));
            item.querySelector('[data-action="edit"]').addEventListener('click', () => handleEdit(location.id));
            item.querySelector('[data-action="delete"]').addEventListener('click', () => handleDelete(location.id));
            historyList.appendChild(item);
          });
        }

        function focusLocation(location) {
          map.setView([location.lat, location.lng], 15);
        }

        function handleEdit(id) {
          if (!id) return;
          const locations = StorageAPI.loadLocations();
          const target = locations.find((item) => item.id === id);
          if (!target) return;
          const nextNote = window.prompt('Update note', target.note || '');
          if (nextNote == null) return;
          StorageAPI.updateLocation(id, { note: nextNote });
          showToast('Location updated');
          refresh();
        }

        function handleDelete(id) {
          if (!id) return;
          if (!window.confirm('Delete this snapshot?')) return;
          StorageAPI.deleteLocation(id);
          showToast('Location removed');
          refresh();
        }

        function requestGeolocation() {
          return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
              reject(new Error('Geolocation unavailable'));
              return;
            }
            navigator.geolocation.getCurrentPosition(resolve, reject, {
              enableHighAccuracy: true,
              timeout: 12000,
              maximumAge: 0,
            });
          });
        }

        async function captureSnapshot() {
          try {
            const position = await requestGeolocation();
            const { latitude, longitude, accuracy } = position.coords;
            const entry = StorageAPI.addLocation({
              lat: latitude,
              lng: longitude,
              accuracy_m: accuracy,
              source: 'device',
            });
            showToast('Snapshot saved');
            map.setView([entry.lat, entry.lng], 15);
            refresh();
          } catch (err) {
            console.warn('Device snapshot failed, using map center', err);
            const center = map.getCenter();
            const entry = StorageAPI.addLocation({
              lat: center.lat,
              lng: center.lng,
              source: 'manual',
            });
            showToast('Manual snapshot saved');
            map.setView([entry.lat, entry.lng], 15);
            refresh();
          }
        }

        async function goToMyLocation() {
          try {
            const position = await requestGeolocation();
            const { latitude, longitude } = position.coords;
            map.setView([latitude, longitude], 15);
            showToast('Centered on your location');
          } catch (err) {
            console.warn('Unable to fetch current position', err);
            showToast('Location unavailable, adjust map manually');
          }
        }

        function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }

        function formatDate(value) {
          const parsed = new Date(value);
          if (Number.isNaN(parsed.getTime())) return '';
          return parsed.toLocaleString();
        }

        function startOfWeek(date) {
          const d = new Date(date);
          d.setHours(0, 0, 0, 0);
          const diff = (d.getDay() + 6) % 7;
          d.setDate(d.getDate() - diff);
          return d;
        }

        function endOfWeek(date) {
          const start = startOfWeek(date);
          const end = new Date(start);
          end.setDate(start.getDate() + 6);
          end.setHours(23, 59, 59, 999);
          return end;
        }

        function startOfMonth(date) {
          const d = new Date(date);
          d.setDate(1);
          d.setHours(0, 0, 0, 0);
          return d;
        }

        function endOfMonth(date) {
          const start = startOfMonth(date);
          const end = new Date(start);
          end.setMonth(end.getMonth() + 1);
          end.setMilliseconds(-1);
          return end;
        }

        snapshotBtn.addEventListener('click', captureSnapshot);
        myLocationBtn.addEventListener('click', goToMyLocation);
        showDayBtn.addEventListener('click', () => {
          state.mode = 'day';
          refresh();
        });
        showWeekBtn.addEventListener('click', () => {
          state.mode = 'week';
          refresh();
        });
        showMonthBtn.addEventListener('click', () => {
          state.mode = 'month';
          refresh();
        });
        dateInput.addEventListener('change', refresh);
        searchInput.addEventListener('input', (event) => {
          state.query = event.target.value.trim();
          refresh();
        });
        exportBtn.addEventListener('click', () => {
          const data = StorageAPI.exportJson();
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `health-map-${new Date().toISOString().slice(0, 10)}.json`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          showToast('Export ready');
        });
        importBtn.addEventListener('click', () => importFile.click());
        importFile.addEventListener('change', async (event) => {
          const file = event.target.files && event.target.files[0];
          if (!file) return;
          try {
            const text = await file.text();
            const payload = JSON.parse(text);
            const result = StorageAPI.importJson(payload);
            showToast(`Import complete: events +${result.events.added}, locations +${result.locations.added}`);
            refresh();
          } catch (err) {
            console.error('Import failed', err);
            showToast('Import failed');
          } finally {
            event.target.value = '';
          }
        });

        window.addEventListener('health:changed', refresh);

        refresh();

        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('./service-worker.js').catch((err) => {
              console.warn('Service worker registration failed', err);
            });
          });
        }
      })();
    </script>
  </body>
</html>

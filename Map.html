<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Map</title>

  <!-- ваш общий стиль (можно убрать, если нет) -->
  <link rel="stylesheet" href="./shared/styles.css" />

  <!-- Leaflet -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    body { margin:0; padding:16px; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .toolbar { display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; margin:0 0 .75rem 0; }
    .toolbar input[type="date"]{ padding:.5rem .6rem; border:1px solid #e2e8f0; border-radius:.6rem; }
    .btn { padding:.55rem .8rem; border-radius:.6rem; border:1px solid #cbd5e1; cursor:pointer; background:#fff; }
    .btn.primary { background:#2563eb; color:#fff; border-color:#2563eb; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    #map { width:100%; min-height:420px; height:62vh; border-radius:16px; }
    .layout { display:grid; grid-template-columns: 1fr 340px; gap:1rem; }
    @media (max-width: 980px){ .layout { grid-template-columns: 1fr; } #map{ height:56vh; } }
    .panel { border:1px solid #e5e7eb; border-radius:14px; padding:.75rem; background:#fff; }
    .list { max-height:60vh; overflow:auto; margin:0; padding:0; list-style:none; }
    .item { border-bottom:1px solid #f1f5f9; padding:.6rem .3rem; display:flex; gap:.5rem; align-items:center; }
    .item:last-child{ border-bottom:none; }
    .item button { margin-left:auto; }
    .muted { color:#64748b; font-size:.9rem; }
    .search { width:100%; padding:.5rem .6rem; border:1px solid #e2e8f0; border-radius:.6rem; }
  </style>
</head>
<body>
  <h1 style="margin:0 0 12px 0;">Location snapshots</h1>

  <!-- панель управления -->
  <div class="toolbar">
    <button id="btnLocate" class="btn">My location</button>
    <button id="btnSnap" class="btn primary">Snapshot</button>

    <input id="inpDate" type="date"/>
    <button class="btn" data-scope="day">Day</button>
    <button class="btn" data-scope="week">Week</button>
    <button class="btn" data-scope="month">Month</button>

    <input id="inpSearch" class="search" placeholder="Search by note" style="flex:1 1 220px; max-width:420px;">
    <button id="btnExport" class="btn">Export JSON</button>
    <button id="btnImport" class="btn">Import JSON</button>
    <input id="fileImport" type="file" accept="application/json" style="display:none;">
  </div>

  <div class="layout">
    <div id="map"></div>

    <div class="panel">
      <div class="muted" style="margin-bottom:.5rem;">History</div>
      <ul id="list" class="list"></ul>
    </div>
  </div>

  <script>
  // ===== Local storage API for locations =====
  const LS_LOCATIONS = 'health_locations_v1';
  const nowIso = () => new Date().toISOString();
  const uuid = () => (crypto.randomUUID ? crypto.randomUUID() :
                     'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{
                        const r=Math.random()*16|0, v=c==='x'?r:(r&0x3|0x8); return v.toString(16);
                     }));

  function loadLocations(){
    try { return JSON.parse(localStorage.getItem(LS_LOCATIONS) || '[]'); }
    catch(e){ return []; }
  }
  function saveLocations(arr){
    localStorage.setItem(LS_LOCATIONS, JSON.stringify(arr));
    // кросс-синк
    window.dispatchEvent(new CustomEvent('health:changed'));
  }
  function addLocation(loc){
    const arr = loadLocations();
    const item = { id: uuid(), note:'', source:'device', created_at: nowIso(), updated_at: nowIso(), ...loc };
    arr.push(item); saveLocations(arr); return item;
  }
  function updateLocation(id, patch){
    const arr = loadLocations();
    const i = arr.findIndex(x=>x.id===id);
    if(i>=0){ arr[i] = { ...arr[i], ...patch, updated_at: nowIso() }; saveLocations(arr); }
  }
  function deleteLocation(id){
    const arr = loadLocations().filter(x=>x.id!==id); saveLocations(arr);
  }

  // ===== date helpers =====
  function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
  function endOfDay(d){ const x=new Date(d); x.setHours(23,59,59,999); return x; }
  function startOfWeek(d){ const x=new Date(d); const wd=(x.getDay()+6)%7; x.setDate(x.getDate()-wd); x.setHours(0,0,0,0); return x; }
  function endOfWeek(d){ const x=startOfWeek(d); x.setDate(x.getDate()+6); x.setHours(23,59,59,999); return x; }
  function startOfMonth(d){ const x=new Date(d.getFullYear(), d.getMonth(), 1); x.setHours(0,0,0,0); return x; }
  function endOfMonth(d){ const x=new Date(d.getFullYear(), d.getMonth()+1, 0); x.setHours(23,59,59,999); return x; }

  // ===== Map =====
  let map, markersLayer;
  let scope = 'day';
  let anchor = new Date();

  const inpDate = document.getElementById('inpDate');
  inpDate.valueAsDate = anchor;

  function initMap(){
    // начальный центр — либо последняя точка, либо Амстердам
    const last = loadLocations().slice(-1)[0];
    const center = last ? [last.lat, last.lng] : [52.37, 4.89];
    map = L.map('map').setView(center, last ? 13 : 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '© OpenStreetMap'
    }).addTo(map);
    markersLayer = L.layerGroup().addTo(map);
    setTimeout(()=>map.invalidateSize(), 0);
  }

  function rangeForScope(sc, d){
    if(sc==='day') return [startOfDay(d), endOfDay(d)];
    if(sc==='week') return [startOfWeek(d), endOfWeek(d)];
    return [startOfMonth(d), endOfMonth(d)];
  }

  function render(){
    markersLayer.clearLayers();
    const [a,b] = rangeForScope(scope, anchor);
    const q = (document.getElementById('inpSearch').value || '').toLowerCase().trim();

    let arr = loadLocations().filter(x=>{
      const t = new Date(x.created_at).getTime();
      return t>=a.getTime() && t<=b.getTime();
    });
    if(q) arr = arr.filter(x => (x.note||'').toLowerCase().includes(q));

    // markers
    arr.forEach(x=>{
      const m = L.marker([x.lat, x.lng]).addTo(markersLayer);
      const when = new Date(x.created_at).toLocaleString();
      m.bindPopup(`<b>${when}</b><br>accuracy: ${x.accuracy_m??'—'} m<br>${(x.note||'')}`);
      m.on('click', ()=> m.openPopup());
    });

    // list
    const ul = document.getElementById('list');
    ul.innerHTML = '';
    if(arr.length===0){
      ul.innerHTML = `<li class="item"><span class="muted">0 snapshots</span></li>`;
    } else {
      arr.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));
      arr.forEach(x=>{
        const li = document.createElement('li'); li.className='item';
        const when = new Date(x.created_at).toLocaleString();
        li.innerHTML = `
          <div>
            <div><b>${when}</b></div>
            <div class="muted">${x.lat.toFixed(5)}, ${x.lng.toFixed(5)} · acc ${x.accuracy_m??'—'} m</div>
            <div contenteditable="true" data-id="${x.id}" class="muted" style="outline:none">${x.note||''}</div>
          </div>
          <button class="btn" data-action="focus" data-id="${x.id}">Focus</button>
          <button class="btn" data-action="delete" data-id="${x.id}">Delete</button>
        `;
        ul.appendChild(li);
      });
    }
  }

  // ===== actions =====
  document.getElementById('btnLocate').onclick = () => {
    if(!('geolocation' in navigator)){
      alert('Geolocation is not available'); return;
    }
    navigator.geolocation.getCurrentPosition(
      pos => map.flyTo([pos.coords.latitude, pos.coords.longitude], 15),
      err => alert('Geolocation error: ' + err.message),
      { enableHighAccuracy:true, maximumAge:5000, timeout:15000 }
    );
  };

  document.getElementById('btnSnap').onclick = () => {
    const save = (lat,lng,acc,source) => {
      const item = addLocation({ lat, lng, accuracy_m: acc, source });
      // быстрый маркер и фокус
      L.marker([item.lat, item.lng]).addTo(markersLayer);
      map.flyTo([item.lat, item.lng], 16);
      render();
    };
    if('geolocation' in navigator){
      navigator.geolocation.getCurrentPosition(
        pos => save(pos.coords.latitude, pos.coords.longitude, Math.round(pos.coords.accuracy||0), 'device'),
        _err => { // без разрешения — центр карты
          const c = map.getCenter(); save(c.lat, c.lng, null, 'manual');
        },
        { enableHighAccuracy:true, maximumAge:5000, timeout:8000 }
      );
    } else {
      const c = map.getCenter(); save(c.lat, c.lng, null, 'manual');
    }
  };

  // смена даты/диапазона/поиска
  inpDate.onchange = () => { anchor = inpDate.valueAsDate || new Date(); render(); };
  document.querySelectorAll('[data-scope]').forEach(btn=>{
    btn.onclick = () => { scope = btn.dataset.scope; render(); };
  });
  document.getElementById('inpSearch').oninput = () => render();

  // список: фокус / удаление / редактирование заметки
  document.getElementById('list').onclick = (e)=>{
    const id = e.target.dataset.id;
    if(!id) return;
    if(e.target.dataset.action==='delete'){ deleteLocation(id); render(); }
    if(e.target.dataset.action==='focus'){
      const x = loadLocations().find(z=>z.id===id);
      if(x){ map.flyTo([x.lat, x.lng], 16); }
    }
  };
  // сохранение заметки (по выходу из фокуса)
  document.getElementById('list').addEventListener('focusout', (e)=>{
    const id = e.target.dataset.id;
    if(id){ updateLocation(id, { note: e.target.innerText.trim() }); render(); }
  });

  // экспорт/импорт
  document.getElementById('btnExport').onclick = ()=>{
    const data = { version:1, locations: loadLocations() };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `locations_${new Date().toISOString().slice(0,10)}.json`;
    a.click(); URL.revokeObjectURL(a.href);
  };
  document.getElementById('btnImport').onclick = ()=> document.getElementById('fileImport').click();
  document.getElementById('fileImport').onchange = async (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const text = await file.text();
    try{
      const incoming = JSON.parse(text).locations || [];
      const mapById = new Map(loadLocations().map(x=>[x.id,x]));
      incoming.forEach(x=>{
        const ex = mapById.get(x.id);
        if(!ex || new Date(x.updated_at) > new Date(ex.updated_at)) mapById.set(x.id, x);
      });
      saveLocations([...mapById.values()]); render();
      alert(`Imported ${incoming.length} snapshots`);
    }catch(err){ alert('Invalid JSON'); }
    e.target.value = '';
  };

  // кросс-вкладки
  window.addEventListener('storage', (e)=>{ if(e.key===LS_LOCATIONS) render(); });
  window.addEventListener('health:changed', render);

  // init
  initMap(); render();
  </script>
</body>
</html>
<script>
/* --- текущая позиция: синяя точка + круг точности --- */
let meMarker = null, meCircle = null;

function showCurrentPosition() {
  if (!('geolocation' in navigator)) {
    alert('Geolocation is not available on this device/browser.');
    return;
  }
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const acc = Math.round(pos.coords.accuracy || 0);

      if (meMarker) { map.removeLayer(meMarker); }
      if (meCircle) { map.removeLayer(meCircle); }

      // синяя точка в центре
      meMarker = L.circleMarker([lat, lng], {
        radius: 7, color: '#2563eb', fillColor: '#2563eb', fillOpacity: 1, weight: 2
      }).addTo(map);

      // круг точности
      meCircle = L.circle([lat, lng], {
        radius: acc, color: '#60a5fa', fillColor: '#93c5fd', fillOpacity: 0.15, weight: 1
      }).addTo(map);

      map.flyTo([lat, lng], 16);
    },
    (err) => {
      alert('Geolocation error: ' + err.message + '\nРазреши доступ к геолокации.');
    },
    { enableHighAccuracy: true, maximumAge: 5000, timeout: 15000 }
  );
}

// привяжем к кнопке
document.getElementById('btnLocate')?.addEventListener('click', showCurrentPosition);

/* --- опционально: снапшот берёт текущую позицию, если она известна --- */
function snapshotFromCurrentOrCenter() {
  const center = map.getCenter();
  const fromCurrent = meMarker?.getLatLng() || null;
  const lat = fromCurrent ? fromCurrent.lat : center.lat;
  const lng = fromCurrent ? fromCurrent.lng : center.lng;
  const acc = meCircle ? meCircle.getRadius() : null;

  // если у тебя уже есть свой addLocation(...) — оставь его
  if (typeof addLocation === 'function') {
    const item = addLocation({ lat, lng, accuracy_m: acc, source: fromCurrent ? 'device' : 'manual' });
    L.marker([item.lat, item.lng]).addTo(markersLayer || map);
    map.flyTo([item.lat, item.lng], 16);
    if (typeof render === 'function') render();
  } else {
    // временный маркер, если хранилища пока нет
    L.marker([lat, lng]).addTo(map).bindPopup('Snapshot').openPopup();
  }
}

// если у тебя кнопка Snapshot имеет id="btnSnap"
document.getElementById('btnSnap')?.addEventListener('click', snapshotFromCurrentOrCenter);
</script>

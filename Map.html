<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Map</title>
    <link rel="stylesheet" href="./shared/styles.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
      defer
    ></script>
  </head>
  <body class="app-shell" data-page="map">
    <aside id="sidenav" class="sidebar" aria-label="Primary navigation"></aside>
    <main class="app-main">
      <div class="container flow">
        <header class="page-header">
          <span class="page-header__eyebrow">Map</span>
          <h1>Location snapshots</h1>
          <p>
            Capture quick snapshots tied to your current location, explore them on the map,
            and sync changes instantly across tabs.
          </p>
          <span class="badge">Spatial memory</span>
        </header>

        <div class="toolbar">
          <button id="btnLocate" class="btn ghost" type="button">My location</button>
          <button id="btnSnap" class="btn primary" type="button">Snapshot</button>
          <input id="inpDate" type="date" class="input" />
          <div class="chip-group" role="group" aria-label="Filter by range">
            <button class="chip active" data-scope="day" type="button">Day</button>
            <button class="chip" data-scope="week" type="button">Week</button>
            <button class="chip" data-scope="month" type="button">Month</button>
          </div>
          <input
            id="inpSearch"
            class="input search-field"
            placeholder="Search by note"
            type="search"
            aria-label="Search snapshots"
          />
          <button id="btnExport" class="btn ghost" type="button">Export JSON</button>
          <button id="btnImport" class="btn ghost" type="button">Import JSON</button>
          <input id="fileImport" type="file" accept="application/json" />
        </div>

        <div class="map-layout">
          <div id="map" class="map" aria-label="Locations map"></div>
          <aside class="panel" aria-label="Snapshot history">
            <div class="muted" style="margin-bottom: 0.5rem;">History</div>
            <ul id="list" class="list"></ul>
          </aside>
        </div>
      </div>
    </main>
    <script src="./assets/js/includes.js" defer></script>
    <script>
      (function () {
        const LS_LOCATIONS = 'health_locations_v1';
        const nowIso = () => new Date().toISOString();
        const uuid = () =>
          (crypto.randomUUID
            ? crypto.randomUUID()
            : 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {
                const r = (Math.random() * 16) | 0;
                const v = c === 'x' ? r : (r & 0x3) | 0x8;
                return v.toString(16);
              }));

        function loadLocations() {
          try {
            return JSON.parse(localStorage.getItem(LS_LOCATIONS) || '[]');
          } catch {
            return [];
          }
        }
        function saveLocations(entries) {
          localStorage.setItem(LS_LOCATIONS, JSON.stringify(entries));
          window.dispatchEvent(new CustomEvent('health:changed'));
        }
        function addLocation(data) {
          const item = { id: uuid(), note: '', source: 'device', created_at: nowIso(), updated_at: nowIso(), ...data };
          const entries = loadLocations(); entries.push(item); saveLocations(entries); return item;
        }
        function updateLocation(id, patch) {
          const entries = loadLocations();
          const i = entries.findIndex((e) => e.id === id);
          if (i >= 0) { entries[i] = { ...entries[i], ...patch, updated_at: nowIso() }; saveLocations(entries); }
        }
        function deleteLocation(id) { saveLocations(loadLocations().filter((e) => e.id !== id)); }

        function startOfDay(d){const n=new Date(d);n.setHours(0,0,0,0);return n;}
        function endOfDay(d){const n=new Date(d);n.setHours(23,59,59,999);return n;}
        function startOfWeek(d){const n=new Date(d);const w=(n.getDay()+6)%7;n.setDate(n.getDate()-w);n.setHours(0,0,0,0);return n;}
        function endOfWeek(d){const n=startOfWeek(d);n.setDate(n.getDate()+6);n.setHours(23,59,59,999);return n;}
        function startOfMonth(d){const n=new Date(d.getFullYear(),d.getMonth(),1);n.setHours(0,0,0,0);return n;}
        function endOfMonth(d){const n=new Date(d.getFullYear(),d.getMonth()+1,0);n.setHours(23,59,59,999);return n;}
        function rangeForScope(v, date){ if(v==='day')return [startOfDay(date), endOfDay(date)]; if(v==='week')return [startOfWeek(date), endOfWeek(date)]; return [startOfMonth(date), endOfMonth(date)]; }

        let map, markersLayer, meMarker=null, meCircle=null, scope='day', anchor=new Date();

        const el = {
          date: document.getElementById('inpDate'),
          search: document.getElementById('inpSearch'),
          list: document.getElementById('list'),
          locate: document.getElementById('btnLocate'),
          snapshot: document.getElementById('btnSnap'),
          scopeButtons: Array.from(document.querySelectorAll('[data-scope]')),
          importInput: document.getElementById('fileImport'),
          importBtn: document.getElementById('btnImport'),
          exportBtn: document.getElementById('btnExport'),
        };
        el.date.valueAsDate = anchor;

        function initMap() {
          const last = loadLocations().slice(-1)[0];
          const center = last ? [last.lat, last.lng] : [52.37, 4.89];
          map = L.map('map'); map.setView(center, last ? 13 : 12);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' }).addTo(map);
          markersLayer = L.layerGroup().addTo(map);
          setTimeout(()=>map.invalidateSize(),0);
        }

        function updateCurrentPosition(lat,lng,acc){
          if (!map) return;
          if (meMarker) { map.removeLayer(meMarker); meMarker=null; }
          if (meCircle) { map.removeLayer(meCircle); meCircle=null; }
          meMarker = L.circleMarker([lat,lng],{radius:7,color:'#2563eb',fillColor:'#2563eb',fillOpacity:1,weight:2}).addTo(map);
          if (Number.isFinite(acc) && acc>0) meCircle = L.circle([lat,lng],{radius:acc,color:'#60a5fa',fillColor:'#93c5fd',fillOpacity:.15,weight:1}).addTo(map);
        }

        function filterLocations(){
          const [start,end]=rangeForScope(scope,anchor);
          const q=(el.search.value||'').toLowerCase().trim();
          return loadLocations().filter(entry=>{
            const t=new Date(entry.created_at).getTime();
            if (t<start.getTime() || t>end.getTime()) return false;
            if (!q) return true;
            return (entry.note||'').toLowerCase().includes(q);
          });
        }

        function render(){
          const items=filterLocations();
          if (markersLayer){ markersLayer.clearLayers();
            items.forEach(e=>{ const m=L.marker([e.lat,e.lng]).addTo(markersLayer);
              const when=new Date(e.created_at).toLocaleString();
              m.bindPopup(`<b>${when}</b><br>accuracy: ${e.accuracy_m ?? '—'} m<br>${e.note || ''}`); });
          }
          el.list.innerHTML='';
          if (!items.length){ const empty=document.createElement('li'); empty.className='item'; empty.innerHTML='<span class="muted">0 snapshots</span>'; el.list.appendChild(empty); return; }
          items.slice().sort((a,b)=>new Date(b.created_at)-new Date(a.created_at)).forEach(e=>{
            const li=document.createElement('li'); li.className='item';
            const when=new Date(e.created_at).toLocaleString();
            li.innerHTML=`
              <div>
                <div><strong>${when}</strong></div>
                <div class="muted">${e.lat.toFixed(5)}, ${e.lng.toFixed(5)} · acc ${e.accuracy_m ?? '—'} m</div>
                <div class="muted" contenteditable="true" data-id="${e.id}" style="outline:none;">${e.note || ''}</div>
              </div>
              <button class="btn ghost" data-action="focus" data-id="${e.id}" type="button">Focus</button>
              <button class="btn" data-action="delete" data-id="${e.id}" type="button">Delete</button>
            `;
            el.list.appendChild(li);
          });
        }

        function focusOn(lat,lng){ if(map){ map.flyTo([lat,lng],16); } }

        function showCurrentPosition(){
          if (!('geolocation' in navigator)) { alert('Geolocation is not available'); return; }
          navigator.geolocation.getCurrentPosition(
            (pos)=>{ const {latitude:lat, longitude:lng, accuracy} = pos.coords;
              updateCurrentPosition(lat,lng,Math.round(accuracy||0)); focusOn(lat,lng); },
            (err)=>{ alert('Geolocation error: '+err.message); },
            { enableHighAccuracy:true, maximumAge:5000, timeout:15000 }
          );
        }

        function snapshotFrom(lat,lng,acc,source){
          const item=addLocation({lat,lng,accuracy_m:acc,source});
          if (markersLayer) L.marker([item.lat,item.lng]).addTo(markersLayer);
          focusOn(item.lat,item.lng); render();
        }

        function snapshotFromCenter(){ const c=map?.getCenter(); if(!c) return; snapshotFrom(c.lat,c.lng,null,'manual'); }
        function snapshot(){
          if (!('geolocation' in navigator)) { snapshotFromCenter(); return; }
          navigator.geolocation.getCurrentPosition(
            (pos)=>{ const {latitude:lat, longitude:lng, accuracy} = pos.coords;
              updateCurrentPosition(lat,lng,Math.round(accuracy||0)); snapshotFrom(lat,lng,Math.round(accuracy||0),'device'); },
            ()=>snapshotFromCenter(), { enableHighAccuracy:true, maximumAge:5000, timeout:8000 }
          );
        }

        el.locate?.addEventListener('click', showCurrentPosition);
        el.snapshot?.addEventListener('click', snapshot);
        el.date.addEventListener('change', ()=>{ anchor=el.date.valueAsDate||new Date(); render(); });
        el.scopeButtons.forEach(b=>b.addEventListener('click',()=>{ scope=b.dataset.scope; el.scopeButtons.forEach(x=>x.classList.toggle('active',x.dataset.scope===scope)); render(); }));
        el.search.addEventListener('input', ()=>render());
        el.list.addEventListener('click', (ev)=>{ const t=ev.target; if(!(t instanceof HTMLElement))return; const {action,id}=t.dataset; if(!id)return;
          if(action==='delete'){ deleteLocation(id); render(); }
          if(action==='focus'){ const item=loadLocations().find(e=>e.id===id); if(item) focusOn(item.lat,item.lng); }
        });
        el.list.addEventListener('focusout',(ev)=>{ const t=ev.target; if(!(t instanceof HTMLElement))return; const id=t.dataset.id; if(!id)return; updateLocation(id,{note:t.innerText.trim()}); render(); });

        window.addEventListener('storage',(e)=>{ if(e.key===LS_LOCATIONS) render(); });
        window.addEventListener('health:changed', render);

        function bootstrap(){ if(typeof L==='undefined'){ requestAnimationFrame(bootstrap); return; } initMap(); render(); }
        bootstrap();
      })();
    </script>
  </body>
</html>
